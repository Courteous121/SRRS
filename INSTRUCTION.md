# SRRS（SCUT RobotLab Radar Station）
**华工机器人实验室雷达站**

[![Build Status](https://ci.scutbot.cn/api/badges/22-duke/SRRS/status.svg)](https://ci.scutbot.cn/22-duke/SRRS)
![](https://img.shields.io/badge/当前版本-V1.0-green.svg)
## 使用方法
1. 克隆本項目。
```
git clone https://git.scutbot.cn/22-duke/SRRS.git
```
2. 修改CMakeLists.txt中`tensorRT`的相關路徑。
3. 編譯本項目。
```
mkdir build
cd build
cmake ..
make -j6
```
4. 修改`Setting_file`中`PathParam.yml`文件的相關路徑，並準備好相關的文件：地圖、檢測模型等。
5. 使用下面的代碼運行本程序。
```
cd build
./RadarStation
```
單純這樣使用雷達站便具備了檢測與發送小地圖數據的功能，若要進行更多操作，可以使用下述參數。
```
--show 顯示所有相關畫面。
--src 顯示相機畫面。
--map 顯示地圖畫面。
--dart 顯示飛鏢相機畫面。
--base 顯示基地相機畫面。
--depth 顯示深度圖畫面。
--write 記錄相機畫面。
--record 記錄相機深度圖。
--c PNP標定功能。標定中按一次ESC鍵可以暫停畫面，按其他鍵繼續，而在暫停時再按一次ESC爲退出標定。
--g 比賽功能，一鍵打開必要畫面：主相機、地圖、飛鏢相機。
```
## 具體使用說明
### 標定功能
- 本功能主要用於現場標定PNP與基地映射情況。
1. 該功能不需要插雷達，但需要保持相機或者視頻的加載
2. 使用下面的指令來進行標定。
```
./RadarStation --c
```
3. 需要注意的是，一般情況需要標定2組點，每組各4個點，第一組點爲PNP的四個點，需要全部標地面的點。後一組點爲基地透視變換的點，也是標地面即可。
4. 但是，考慮到激光雷達隨時可能下線，我貼心地準備了備用定位方案，只是需要標3組點，第一組是PNP點保持不變，同時三組點分別代表低中高三個平面的透視變換點位，即第一組是共用的。開啓方法也很簡單，在cmake時將`LIDAR_DAMAGE`打開即可，終端會出現我的嘲諷以提示你打開了這個功能。編譯後和上面的使用方法一致。注意，使用完後要恢復一般模式，需要將ON改成OFF再cmake一次。
```
cmake .. -DLIDAR_DAMAGE=ON
```
- 考慮到方便操作者在賽場可以按照需求即使更換小地圖上的預先標註點，操作者可以自行打開`modules/calibrator/Calibrator.cpp`，在大約205行找到下面的句子進行自行修改。你所需要的小地圖上的座標可以在標定界面標定完一個點後，在終端查看輸出。
```
   // ------------------------------看這裏---------------------------------------
    // 小地圖預先標註點，注意先後順序
    allObjectPoint.emplace_back(Point(161, 186));
    allObjectPoint.emplace_back(Point(267, 60));
    allObjectPoint.emplace_back(Point(288, 287));
    allObjectPoint.emplace_back(Point(399, 86));
    // ------------------------------看這裏---------------------------------------

```
### 錄製功能
- 本功能主要用於記錄比賽時的數據。
1. 運行雷達。
2. 使用下面的指令來記錄數據，其中`--write`是用於記錄視頻數據，`--record`是用於記錄深度圖數據。
```
./RadarStation --write --record
```
3. 關閉雷達程序（必須關閉，否則視頻文件無法打開），前往指定的數據存放點觀察是否產生了數據。數據存放位置的設定在`PathParam.yml`文件中，其中`videosave_path`爲視頻存儲路徑，`depthmatsave_path`爲深度圖存儲路徑。
4. 如果不存在視頻數據，則有可能是存放路徑出現錯誤。如果存在視頻數據，但是視頻無法打開且文件大小很小，則可能是視頻編碼存在問題，安裝對應的編碼格式即可。
5. 如果不存在深度圖數據，則可能是存放路徑出現問題，或者權限問題，增加`sudo`指令運行即可。
### 飛鏢相機功能
- 飛鏢相機全程都會開着，但是爲了減少錄製後飛鏢的人花大量時間在時間長河中尋找他們的發射片段，我設定了只有在他們艙門打開時才會錄製，如果你需要關閉這個功能，在編譯時如下輸入：
```
cmake .. -DDART_CORRECT=OFF
```
- 因爲飛鏢使用的是工業相機，可能會出現找不到相機的尷尬權限情況，這時請參考視覺組往年資料自行解決。
## 關於本項目的說明
1. 本項目基於22屆雷達站項目源碼重構。
2. 本項目旨在規範化開發流程以及方便往後的同學在此基礎上繼續開發，而無需每年都重新造輪子。

